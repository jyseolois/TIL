# 스레드간 공유되는 프로세스 리소스

## 스레드 전용 리소스(thread-private resources)
- 상태 변화 관점에서 보면 스레드는 사실 함수 실행이다. CPU는 하나의 진입 함수의 명령어를 실행해서 실행 흐름인 스레드를 형성하기 때문이다.
- 그렇다면 바로 함수 실행에 필요한 정보가 스레드 전용 리소스라는 뜻이다.
- 함수의 실행 시간 정보는 스택 영역을 구성하는 스택 프레임에 저장된다. 이때 스택 프레임에는 함수의 반환값, 다른 함수를 호출할 때 전달되는 매개변수, 함수 내에서 사용되는 지역 변수와 레지스터 정보가 저장된다.
- 각 스레드는 자신만 사용할 수 있는 스택 영역을 가지므로, 스레드가 여러 개 있을 때는 여러 스택 영역이 존재하게 되는 것이다.
- 스택 영역 외에는 다음에 실행될 명령어 주소를 저장하는 PC 레지스터(register), 스레드 스택 영역에서 스택 상단(setack top) 위치를 저장하는 스택 포인터(stack pointer) 등 CPU가 기계 명령어를 실행할 때 내부 레지스터 값도 스레드의 현재 실행 상태에 속한다. 이런 레지스터 정보도 역시 스레드 전용으로, 다른 스레드에서는 이런 레지스터 정보에 접근할 수 없다.
- 스레드 상황 정보(thread context): 스레드에 속한 스택 영역, 프로그램 카운터, 스택 포인터, 함수 실행 시 사용되는 레지스터 정보를 통틀어 스레드 상황 정보(thread context)라고 한다.
- 전용 리소스를 제외한 나머지는 모두 스레드 간에 공유되는 리소스에 해당한다. 즉, 스레드는 프로세스 주소 공간에서 스택 영역을 제외한 나머지 영역(힙, 데이터, 코드)를 모두 공유한다. 

## 코드 영역: 모든 함수를 스레드에 배치하여 실행할 수 있다
- 프로세스 주소 공간의 코드 영역에는 컴파일 후 생성된 실행 가능한 기계 명령어가 저장된다. 이런 기계 명령어는 실행 파일에 저장되어 있으며, 프로그램이 시작될 때 프로세스 주소 공간에 적재된다.
- 코드 영역을 스레드간에 공유되므로 어떤 함수든지 모두 스레드에 적재하여 실행할 수 있고, 특정 함수를 특정 스레드에서만 실행되도록 하는 것은 불가능하다. 따라서 코드 영역은 모든 스레드가 공유하는 영역이다.
- 코드 영역은 읽기 전용(read-only)이기 때문에, 프로그램이 실행되는 동안에는 어떤 스레드도 코드 영역 내용을 변경할 수는 없다. 따라서 프로세스 내 모든 스레드가 코드 영역을 공유하고 있지만, 코드 영역에 관해서는 스레드 안전 문제(thread safety issue)가 발생하지 않는다. 

## 데이터 영역: 모든 스레드가 데이터 영역의 변수에 접근할 수 있다
- 데이터 영역은 전역 변수가 저장되는 곳이다.
- 프로그램이 실행되는 동안 데이터 영역 내에 전역 변수의 인스턴스(instance)는 하나만 있기 때문에, 모든 스레드는 이 전역 변수에 접근할 수 있다.
- 다시 말해, 어떤 스레드가 이 전역 변수 값을 변경하면, 이후 다른 스레드에서 이 전역 변수 값을 확인해도 변경된 상태라는 의미이다.

## 힙 영역: 포인터가 핵심이다
- 힙 영역은 C/C++ 언어에서 malloc 함수와 new 예약어로 요청하는 메모리가 이 영역에 할당된다.
- 모든 스레드는 해당 변수 주소만 알 수 있다면, 다시 말해 포인터(pointer)만 얻을 수 있다면, 포인터가 가리키는 데이터에 접근할 수 있다. (모든 스레드는 포인터 s를 획득하면 해당 포인터가 가리키는 데이터에 접근할 수 있다)

---

**힙 영역 (Heap Segment)**

- 저장 내용: 동적으로 할당된 객체나 배열이 저장된다.
- JVM의 가비지 컬렉터가 메모리를 자동으로 관리해준다. 즉, 더 이상 사용되지 않는 객체는 가비지 컬렉션을 통해 정리된다.
- 여러 스레드가 동일한 힙 메모리의 객체를 참조할 수 있다. 그러나 이 경우 동시 접근에 대한 동기화 처리가 필요할 수 있다.

코드 영역: 함수와 명령어 코드가 저장되는 영역, 읽기 전용이며 모든 스레드가 접근 가능.  
데이터 영역: 전역 변수와 정적 변수가 저장되는 영역, 모든 스레드가 공유.  
힙 영역: 동적으로 생성된 객체가 저장되는 영역, 포인터를 통해 모든 스레드가 접근 가능.  
스택 영역: 함수 호출 시 생성되는 지역 변수들이 저장되는 영역, 각 스레드마다 독립적.

---

## 스택 영역: 공유 공간 내 전용 데이터
- 스택 영역은 스레드 전용 데이터이지만, 스택 영역에는 별도의 보호를 위한 작동 방식이 존재하지 않기 때문에, 다른 스레드에서 특정 스레드의 스택 영역을 볼 수 있다.
- 하나의 스레드가 다른 스레드의 스택 프레임에서 포인터를 가져올 수 있다면 해당 스레드는 다른 스레드의 스택 영역을 직접 읽고 쓸 수 있다. 다시 말해, 스레드 여러 개가 하나의 프로세스에 속하는 경우, 하나의 스레드가 다른 스레드의 스택 영역이라고 하더라도 모두 데이터를 읽고 쓸 수 있다. 
- 이런 스레드 간의 미격리는 원인을 찾아내기 힘든 버그(bug)를 야기할 수 있다. 


## 동적 링크 라이브러리와 파일
- 링크는 컴파일 후에 최종적으로 실행 파일을 생성하는 핵심적인 단계이다.
- 정적 링크는 종속된 모든 라이브러리가 실행 파일에 포함된다. 모든 코드와 데이터가 포함되어 있기 때문에, 프로그램을 시작할 때 추가적인 작업이 필요하지 않는다.
- 동적 링크에는 실행 파일에 종속된 라이브러리의 코드와 데이터가 포함되어 있지 않기 때문에, 프로그램을 시작할 때 또는 실행 중일 때 종속된 라이브러리의 코드와 데이터를 찾아서 프로세스 주소 공간에 넣는 링크 과정이 완료되어야 한다.
- 동적 라이브러리의 코드와 데이터는 스택 영역과 힙 영역 중간에 있는 여유 공간에 배치되고, 이 영역은 모든 스레드가 공유하고 있다. 다시 말해, 프로세스 내 모든 스레드가 동적 라이브러리 코드의 데이터를 사용할 수 있다는 의미이다.
- 프로그램이 동작 중에 특정 파일을 열면 프로세스 주소 공간에 열린 파일 정보도 저장된다. 프로세스가 연 파일 정보는 모든 스레드에서 사용할 수 있으며, 이것 역시 스레드 간 공유 리소스에 속한다. 

## 스레드 전용 저장소 
- 스레드 전용 저장소(thread local storage): 이곳에 저장되는 변수는 모든 스레드에서 접근할 수 있지만, 변수의 인스턴스는 각각의 스레드에 속하기 때문에, 하나의 스레드에서 변수 값을 변경해도 다른 스레드에는 반영되지 않는다.
- 전역 변수 a 앞에 __thread라는 수식어를 붙이면 컴파일러가 전역 변수 a를 스레드 전용 저장소에 넣도록 지시하는 것이다. 따라서 스레드 t1에서 실행된 전역 변수 a에 대한 수정은, 스레드 t2에는 영향을 미치지 않는다. 
- 이렇게 스레드 전용 저장소를 사용하면 각각의 스레드에서 독점적으로 변수를 사용할 수 있다. 즉, 이 변수들은 모든 스레드에서 접근할 수 있지만, 해당 변수는 초기화한 후 각각의 스레드가 복사본을 가지게 되며, 하나의 스레드에서 변수 값을 변경하더라도, 다른 스레드에는 영향을 미치지 않는다. 